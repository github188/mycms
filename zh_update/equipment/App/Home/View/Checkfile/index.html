<!DOCTYPE html> 
<html>
    <head>
        <title>GTP传输失败文件查询</title>
        <meta charset="UTF-8"> 
<!--        <meta name="viewport" http-equiv="X-UA-Compatible" content="IE=9;IE=8;IE=7;IE=edge,chrome=1,width=device-width, initial-scale=1.0">-->
        <meta  content="IE=9;IE=8;IE=7;IE=edge,chrome=1">
        <script src="__PUBLIC__/jquery-1.12.3.min.js" type="text/javascript" ></script> 
        <!--link rel="stylesheet" type="text/css" href="__PUBLIC__/ztree/css/metroStyle/metroStyle.css" /--> 
        <!--script type="text/javascript" src="__PUBLIC__/ztree/js/jquery.ztree.all.min.js"></script-->
        <link href="__PUBLIC__/bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <link href="__PUBLIC__/bootstrap/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
        <script src="__PUBLIC__/bootstrap/js/bootstrap.min.js" type="text/javascript" ></script> 
        <script type="text/javascript" src="__PUBLIC__/bootstrap/js/bootstrap-datetimepicker.min.js"></script> 
        <link rel="stylesheet" href="__PUBLIC__/home/css/jquery.mCustomScrollbar.min.css">
        <!--[if lt IE 9]>
        <script src="__PUBLIC__/bootstrap/js/respond.js" type="text/javascript" ></script>
        <script src="__PUBLIC__/bootstrap/js/html5shiv.js" type="text/javascript" ></script>
        <script src="__PUBLIC__/bootstrap/js/css3-mediaqueries.js"></script>
        <![endif]--> 
        <link href="__PUBLIC__/home/css/style.css" rel="stylesheet">
        <link href="__PUBLIC__/home/css/report.css" rel="stylesheet">
        <link href="__PUBLIC__/font-awesome/css/font-awesome.min.css" rel="stylesheet">   
        <link href="__PUBLIC__/home/font-awesome/css/font-awesome.min.css" rel="stylesheet">   
        <script src="__PUBLIC__/home/js/bootstrap-hover-dropdown.min.js" type="text/javascript"></script>  
        <!-- script src="__PUBLIC__/home/js/header.js" type="text/javascript"></script -->  
        <script src="__PUBLIC__/home/js/layer/layer.js" type="text/javascript"></script>             
        <script src="__PUBLIC__/home/js/laydate/laydate.js" type="text/javascript"></script> 
        <script src="__PUBLIC__/home/js/pdfobject.min.js" type="text/javascript"></script>  
        <link rel="stylesheet" type="text/css" href="__PUBLIC__/home/css/equipment.css"> 
    </head>

<body>
<div class="body" style="margin-top:0px;">
    <div class="mod-shop">
        <div class="shop-head-title">
            <div class="shop-head-mod clearfix">
                <h2><a href="__ROOT__/index.php/Home/Index" class="shop-tit-back">
                       </a><span>GTP传输失败文件查询</span></h2> 
                    <div class="pull-right" style="margin-top:11px;"> 
                    <!--<button id="input_trouble_info" onclick="location.href='__ROOT__/index.php/Home/sms/lists'" class="btn btn-info">查询记录</button>-->  
                </div>
            </div>
        </div>
        <div class="shop-body">
            <div class="shop-container">
                <form id="inputs" name="inputs"> 
                    <ul class="shop-list" style="width:900px">
                        <li class="list" style="width:400px;float:left;"><label class="shop-list-tit"><span>开始时间:</span></label>
                            <div class="shop-list-con">
                                <div class="shop-ui-block ui-block-auto">
                                    <input type="text" class="form-control" id="strtime" name="strtime" onclick="laydate({istime: true, format: 'YYYY-MM-DD hh:mm:ss'})"> 
                                </div>
                                <!--<span style="color:red;">若为空,则立即生效</span>-->
                            </div></li>
                            <li class="list" style="width:400px;float:left;"><label class="shop-list-tit"><span>结束时间:</span></label>
                            <div class="shop-list-con">
                                <div class="shop-ui-block ui-block-auto">
                                    <input type="text" class="form-control" id="endtime" name="endtime" onclick="laydate({istime: true, format: 'YYYY-MM-DD hh:mm:ss'})">
                                </div>
                                <!--<span style="color:red;">若为空,则永久生效</span>-->
                            </div></li>
                            <li>
                                <div class="shop-submit"> 
                            <a class="shop-btn" id="sub_check" href="javascript:void(0)">查询</a>
                        </div> 
                            </li>
                    </ul>  
                </form>
                 <div class="slice"></div>
                    <div class="shop-submit-wrap">
                        
                    
                      <!--start -->
                <link rel="stylesheet" href="__PUBLIC__/home/css/user.css"> 
<div class="container shop-submit" style="margin-top:0px;">
<!--     <div id="tabs_title" class="tabsindex"> 
        <div class="active" id="tabs_users" onclick="changetabs('users')" temp="tabs"><i class="icon-user"></i>  用户管理</div>
    </div> -->
    <div style="overflow: auto; position: relative; width: 100%;" id="indexcontent">
        <div style="margin:10px;" id="content_allmainview">   
            <div id="content_users"  style="display: block;">  
                <div id="admin">
                    <div id="tablebody" style="position:relative;">
                        <table style="margin:0px" class="table table-striped table-bordered table-hover"  > 
                            <tr>
                                <th width="40"></th>  
                                <th nowrap="">
                                    <div align="center" >开始时间</div>
                                </th> 
                                <th nowrap="">
                                    <div align="center" > 结束时间
                                        </div>
                                </th>
                                <th nowrap="">
                                    <div align="center">查询状态 </div>
                                </th> 
                                <th >
                                    <div align="center">操作 </div>
                                </th> 
                                <th>
                                    <div align="center">查询时间 </div>
                                </th> 
                            </tr> 
                            <tbody id="tableShowUsers">
                            <volist name='infolist' id='infolist' key='key'>
                                <tr>
                                    <td align="center"  width="40">
                                        {$key}
                                        <input type="hidden" name="id" value="{$infolist.id}"> 
                                    </td>  
                                    <td align="center">
                                        {$infolist.strtime}
                                    </td> 
                                    <td align="center">
                                        {$infolist.endtime}
                                    </td>
                                    <td align="center">
                                        <if condition="$infolist.status eq 'Y'">
                                            已完成
                                        <else/>
                                            正在查询
                                        </if> 
                                    </td>
                                    <td align="center">
                                        <button filename="{$infolist.filename}" id="scan_results"    class="btn btn-success" type="button" >查看</button> 
                                    </td> 
                                    <td align="center">
                                        {$infolist.indate}
                                    </td> 
                                </tr>
                            </volist> </tbody>
                        </table>
                    </div> 
                    <div id="tablefanye">
                    <input type="hidden" name="key" value="0" selected>
                        <div role="toolbar" class="btn-toolbar" style="margin-top:10px">
                            <div class="btn-group">
                                <button class="btn btn-default" title="首页" data-placement="top" data-toggle="tooltip" type="button" id="shouye" disabled="">«</button>
                                <button class="btn btn-default" disabled="" type="button" title="上一页" data-placement="top" data-toggle="tooltip" id="shang">&lt;</button>
                                <button {$pages.disabled} class="btn btn-default" type="button" id="pageList">第
                                    <span id="pages">1</span>页/共
                                    <span id="maxpage">{$pages.page}</span>页
                                    <span class="caret"></span></button>
                                <button {$pages.disabled}  class="btn btn-default" title="下一页" data-placement="top" data-toggle="tooltip" type="button" id="next">&gt;</button>
                                <button  {$pages.disabled} class="btn btn-default" title="尾页" data-placement="top" data-toggle="tooltip" type="button" id="lastye">»</button></div>
                            <div class="btn-group">
                                <!--<button class="btn btn-default" title="刷新" data-placement="top" data-toggle="tooltip" type="button" id="refresh" onclick="reFreshData();">
                                    <i class="icon-refresh"></i>
                                </button>-->
                            </div>
                            <div style="float:right; padding-top:3px" class="btn-group">
                                <span>共记录
                                    <span id="zjilu">{$pages.total}</span>条</span>每页
                                <input type="number" style="width:40px;text-align:center;height:24px;border:1px #dddddd solid;margin:0px 2px;font-size:12px" value="{$pages.pagesize}" id="pagesize" onfocus="" onblur="cPageSize(this)" maxlength="3">条</div></div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
                     
                    
                    </div>
            </div>
        </div>
     
    
</div>
    
</div>

<script src="__PUBLIC__/home/js/clearForm.js" type="text/javascript"></script> 
<script src="__PUBLIC__/home/js/checkfile.js" type="text/javascript"></script> 
<script type="text/javascript">
function deleteHistoryLog(filename){
    layer.confirm('结果文件已被清理，是否删除本条记录？',
       {'title':'提示信息',
       'btn':['删除','取消']},
       function (){
           $.ajax({
            url: './Checkfile/deleteHistoryLog?filename='+filename,
            success: function (json) {
                json = eval("(" + json + ")");
                layer.closeAll();
                if (json.code == '10000') { 
                    layer.msg(json.msg,function(){
                        location.reload();
                    }); 
                } else {
                    layer.msg(json.msg); 
                }
            }
        })
       }
    );
}
$(function(){
    var date = new Date();
    var hours =  minutes =  secondes ='';
    if(date.getHours()<10){
       hours = '0'+date.getHours();
    }else{
         hours = date.getHours();
    }
    if(date.getMinutes()<10){
       minutes = '0'+date.getMinutes();
    }else{
         minutes = date.getMinutes();
    }
    if(date.getSeconds()<10){
       secondes = '0'+date.getSeconds();
    }else{
         secondes = date.getSeconds();
    }
    var month = ((date.getMonth() + 1)<10)?("0"+(date.getMonth() + 1)):(date.getMonth() + 1);
    var ndate = (date.getDate()<10)?("0"+date.getDate()):date.getDate();
    var nowdate = date.getFullYear() + '-' + month + '-' + ndate+" "+hours+':'+minutes+':'+secondes;
    $("#strtime,#endtime").val(nowdate);
    
    $("#sub_check").click(function(){
        var strtime = $("#strtime").val();
        var endtime = $("#endtime").val();  
        if(!strtime){
            layer.msg("开始时间不能为空！");
            $("#strtime").focus();
            return false;
        }
        if(!endtime){
            layer.msg("结束时间不能为空！");
            $("#endtime").focus();
            return false;
        }
        $.ajax({
            url:"__ROOT__/index.php/Home/checkfile/doCheck",
            type:"post",
            data:$("#inputs").serialize(),
            success:function(json){
                json = eval("("+json+")");
                layer.msg(json.msg,function(){
                    location.reload();
                }); 
            }
        });
        return false;
    });

    $("#tableShowUsers").on('click','#scan_results',function(){
        var filename = $(this).attr("filename");
        console.log(filename);
        $.ajax({
            url:"__ROOT__/index.php/Home/checkfile/scanResult?filename="+filename,
            type:"post", 
            success:function(json){
                json = eval("("+json+")"); 
                if(json.code=='10000'){
                    $show = layer.open({
                        'title':'查询结果-'+filename,
                        'area':['700px','90%'],
                        'content':json.msg
                    });
                }else if(json.code=='10001'){
                    deleteHistoryLog(filename);
                } else{
                    layer.msg(json.msg);
                }
            }
        });
        return false;
    }); 
    setInterval(function(){
        $.ajax({
        url: './checkfile/checkingToTemp' 
        })
    },10000);
    setInterval(function(){
        
   var page = $("#pages").html(); 
    var size = $("#tablefanye #pagesize").val();
    var key = $("#content_allmainview").find('#content_users #SUserKey').attr('selected');
    var keys = '';
    if (key) {
        keys += '&keyword=';
        keys += $("#content_allmainview").find('#content_users #SUserKey').val();
        keys += '&key=';
        keys += $('select[name=monthx]').val();
    }
    $.ajax({
        url: './checkfile/pageFlush?page=' + parseInt(page) + '&pagesize=' + size + keys,
        success: function (json) {
            json = eval("(" + json + ")");
            showSearchResult(json);
        }
    })
    },3000);
});

</script> 
</body>
</html>